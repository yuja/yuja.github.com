<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Qt 4.6.3 を MinGW でスタティックリンク用にビルドする - tcha.org</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="/assets/style.css" media="screen">
        <link rel="alternate" type="application/atom+xml" title="tcha.org Blog" href="/blog.atom">
        <meta name="generator" content="nanoc 3.1.0">
    </head>
    <body>
        <div id="sitenav">
            <a href="/blog/">Blog</a>
            | <a href="/about/">About</a>
        </div>
        <div id="main">
            
            <div id="breadcrumbs"><a href="/">tcha.org</a> » <a href="/blog/">Blog</a> »</div>
            

            
<h1>Qt 4.6.3 を MinGW でスタティックリンク用にビルドする</h1>




<address class="head">
    2010 年 7 月 18 日
    <a href="http://b.hatena.ne.jp/append?http://tcha.org/blog/2010/07/18/qt-static-build-mingw/"><img src="http://b.hatena.ne.jp/images/append.gif" width="16" height="12" alt="はてなブックマークへ追加" title="はてなブックマークへ追加"></a>
<a href="http://b.hatena.ne.jp/entry/http://tcha.org/blog/2010/07/18/qt-static-build-mingw/"><img src="http://b.hatena.ne.jp/entry/image/http://tcha.org/blog/2010/07/18/qt-static-build-mingw/" alt="はてなブックマーク - Qt 4.6.3 を MinGW でスタティックリンク用にビルドする" title="はてなブックマーク - Qt 4.6.3 を MinGW でスタティックリンク用にビルドする"></a>

    <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent('http://tcha.org/blog/2010/07/18/qt-static-build-mingw/')+'&title='+encodeURIComponent('Qt 4.6.3 を MinGW でスタティックリンク用にビルドする'),'delicious', 'toolbar=no,width=550,height=550'); return false;"><img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Bookmark this on Delicious" title="Bookmark this on Delicious"></a>

</address>



            <p>Qt 4.6.3 をスタティックリンク用にビルドした。
手順は分かりやすい。だがしかし、ハマった。</p>

<p><strong>2011-09-18 追記:</strong>
Visual Studio でのビルド方法や、ソースコードの取得方法については
<a href="/blog/2011/09/18/qt-static-build-msvc/">Qt 4.7.4 を VS2008 でスタティックリンク用にビルドする</a>
を参照してください。。</p>

<h2>環境</h2>

<ul>
<li>Windows XP (32bit)</li>
<li>MinGW (Qt SDK for Windows についてきたもの)</li>
<li>シャドウビルド (ソースツリーの外でビルド)</li>
</ul>


<h2>手順</h2>

<ol>
<li><p>ソースコードを展開</p>

<p><a href="http://qt.nokia.com/downloads">http://qt.nokia.com/downloads</a> より Qt libraries 4.6.3 <strong>for Linux/X11</strong> をダウンロードする。
for Linux という名前だけど、これは全プラットフォーム対応のソースコード。</p>

<p><code>qt-everywhere-opensource-src-4.6.3.zip</code> を <code>C:\Qt</code> に展開し、
フォルダ名を <code>C:\Qt\4.6.3_src</code> に変える。</p></li>
<li><p>ソースコードにパッチを当てる (4.6.3 のみ)</p>

<p>そのままで Qt のビルドは通るのだけど、 Qt を使ったアプリケーションがリンクできない。やれやれ。</p>

<p>パッチ <a href="/blog/2010/assets/q-decl-import.diff">q-decl-import.diff</a> を当てる。</p></li>
<li><p>configure</p>

<p>C:\Qt\4.6.3_static というフォルダを作って、 configure を実行する。
Perl が必要。</p>

<pre><code> C:\Qt\4.6.3_static&gt;set QTDIR=C:\Qt\4.6.3_src
 C:\Qt\4.6.3_static&gt;set PATH=C:\Qt\4.6.3_static\bin;C:\Qt\4.6.3_src\bin;C:\Qt\2010.04\mingw\bin;%PATH%
 C:\Qt\4.6.3_static&gt;set QMAKESPEC=win32-g++
 C:\Qt\4.6.3_static&gt;..\4.6.3_src\configure -release -opensource -static -no-exceptions -no-stl
     -no-qt3support -no-phonon -no-multimedia -no-webkit -no-script -no-scripttools -no-opengl
     -no-style-plastique -no-style-cleanlooks -no-style-motif -no-style-cde
     -nomake tools -nomake examples -nomake demos -nomake docs -nomake translations
</code></pre>

<p>MinGW は C:\Qt\2010.04\mingw\bin にインストールされていたものを使った。</p>

<p>[2010-07-18 追記] mingwm10.dll への依存を落とすため -no-exceptions を指定。
また、バイナリサイズを小さくしたいので -no-stl (Qt の STL 互換 API を落とす) を追加した。</p></li>
<li><p>ビルド</p>

<pre><code> C:\Qt\4.6.3_static&gt;mingw32-make
</code></pre>

<p>2 時間ぐらいかかるので気長に待とう。</p></li>
<li><p>完了</p></li>
<li><p>試しにアプリケーションをビルドしてみる</p>

<p>KDiff3 をビルドしてみた。</p>

<pre><code> Z:\work\kdiff3\src-QT4&gt;set QTDIR=C:\Qt\4.6.3_static
 Z:\work\kdiff3\src-QT4&gt;set PATH=C:\Qt\4.6.3_static\bin;C:\Qt\2010.04\mingw\bin;%PATH%
 Z:\work\kdiff3\src-QT4&gt;set QMAKESPEC=win32-g++
 Z:\work\kdiff3\src-QT4&gt;qmake
 Z:\work\kdiff3\src-QT4&gt;mingw32-make release
</code></pre></li>
</ol>


<p>Windows でコマンド叩くのはほんとめんどくさいね。
今度は Linux 上でクロスビルド環境を作ってみるか。</p>

<h2>ポイント</h2>

<ul>
<li><p>ソースコード版を用意する。 Qt SDK for Windows を使わない。</p>

<p>Qt SDK for Windows をインストールすれば、 <code>C:\Qt\2010.04\qt</code> にソースコードがあるのだけれど、
これはそのまま使えなかった。</p>

<blockquote><p>The original Qt source package must be left untouched - configure must never
have been run in the source tree directory.</p></blockquote>

<p>Qt SDK for Windows のソースツリーは、インストール時点で configure されているっぽい。</p>

<p>このままでも Qt のビルドは通るのだけれど、アプリケーションをビルドするときに <code>qmake</code> がスタティックリンク用の
<code>Makefile</code> を吐いてくれない。
元のツリー <code>C:\Qt\2010.04\qt</code> を見てしまっている。</p></li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="http://www.formortals.com/build-qt-static-small-microsoft-intel-gcc-compiler/">Building Qt Static (and Dynamic) and Making it Small with GCC, Microsoft Visual Studio, and the Intel Compiler</a></li>
<li><a href="http://doc.trolltech.com/main-snapshot/shadow-builds-wince.html">Qt Snapshot: 2010-07-17 (Saturday) 03:40:47: Windows CE - Using shadow builds</a></li>
<li><a href="http://www.qtcentre.org/threads/31684-Problems-creating-Qt-4.6.3-static-with-MinGw">Problems creating Qt 4.6.3 static with MinGw</a></li>
</ul>


            

            
            <div id="comments">
                <h2>コメント</h2>
                <div id="disqus_thread"></div>
                <script type="text/javascript" src="http://disqus.com/forums/tchaorg/embed.js"></script>
                <noscript>
                    <a href="http://disqus.com/forums/tchaorg/?url=ref">View the discussion thread.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
        </div>

        <script type="text/javascript"><!--
            (function() {
                var links = document.getElementsByTagName('a');
                var query = '?';
                for(var i = 0; i < links.length; i++) {
                    if(links[i].href.indexOf('#disqus_thread') >= 0) {
                        query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
                    }
                }
                document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/tchaorg/get_num_replies.js' + query + '"></' + 'script>');
            })();
        // --></script>
    </body>
</html>
