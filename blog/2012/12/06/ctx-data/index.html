<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>本当は怖いエクステンション - Mercurial Advent Calendar 2012 - tcha.org</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="/assets/style.css" media="screen">
        <link rel="alternate" type="application/atom+xml" title="tcha.org Blog" href="/blog.atom">
        <meta name="generator" content="nanoc 3.1.0">
    </head>
    <body>
        <div id="sitenav">
            <a href="/blog/">Blog</a>
            | <a href="/about/">About</a>
        </div>
        <div id="main">
            
            <div id="breadcrumbs"><a href="/">tcha.org</a> » <a href="/blog/">Blog</a> »</div>
            

            
<h1>本当は怖いエクステンション - Mercurial Advent Calendar 2012</h1>




<address class="head">
    2012 年 12 月 6 日
    <a href="http://b.hatena.ne.jp/append?http://tcha.org/blog/2012/12/06/ctx-data/"><img src="http://b.hatena.ne.jp/images/append.gif" width="16" height="12" alt="はてなブックマークへ追加" title="はてなブックマークへ追加"></a>
<a href="http://b.hatena.ne.jp/entry/http://tcha.org/blog/2012/12/06/ctx-data/"><img src="http://b.hatena.ne.jp/entry/image/http://tcha.org/blog/2012/12/06/ctx-data/" alt="はてなブックマーク - 本当は怖いエクステンション - Mercurial Advent Calendar 2012" title="はてなブックマーク - 本当は怖いエクステンション - Mercurial Advent Calendar 2012"></a>

    <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent('http://tcha.org/blog/2012/12/06/ctx-data/')+'&title='+encodeURIComponent('本当は怖いエクステンション - Mercurial Advent Calendar 2012'),'delicious', 'toolbar=no,width=550,height=550'); return false;"><img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Bookmark this on Delicious" title="Bookmark this on Delicious"></a>

</address>



            <p><a href="http://connpass.com/event/1431/">Mercurial Advent Calendar 2012</a>
の 6 日目です。</p>

<p><a href="http://d.hatena.ne.jp/hokorobi/20121205/1354634570">@h0k0r0bi さんの hg now を作ったよ</a>
というバトンを受け、予定を変えて自作エクステンションの紹介をしようと思います。
リポジトリ変換や hgweb の話はまた後日しますね。</p>

<h2>are you textful?</h2>

<p><a href="http://mercurial.selenic.com/wiki/TextfulExtension">textful エクステンション</a> は、
リポジトリのファイルにフィルタをかけて、見やすくするための拡張機能です。</p>

<p>例えば、</p>

<ul>
<li>文字コードの変換や</li>
<li>エクセル方眼紙をテキスト化</li>
</ul>


<p>して、 <code>hg diff</code> や <code>kdiff3</code> で差分を見られるようになります。</p>

<h2>どうやってるの?</h2>

<p><a href="http://selenic.com/repo/hg/file/5cafcac2414c/mercurial/context.py#l490">fctx.data() メソッド</a>
を差し替えています。</p>

<p><code>fctx.data()</code> は、リポジトリや作業コピーのファイルへアクセスするためのインターフェースです。
なので、このメソッドをハックすればファイルの内容を化かせるんですね。</p>

<p><code>fctx</code> オブジェクトは、 <code>localrepo -&gt; ctx -&gt; fctx</code> という経路でできるので、
まずは <code>localrepo</code> を差し替えます。</p>

<pre><code>def wraprepo(repo):
    class textfulrepo(repo.__class__):
        def __getitem__(self, changeid):
            ctx = super(textfulrepo, self).__getitem__(changeid)  # 本物の ctx
            if changeid is None:
                return wrapworkingctx(ctx)  # 作業コピー
            return wrapchangectx(ctx)       # リポジトリのリビジョン
        # 略
    repo.__class__ = textfulrepo
</code></pre>

<p>次は <code>ctx</code> です。 <code>changectx</code> と <code>workingctx</code> で若干引数が異なるので、
それぞれ関数を定義します。</p>

<pre><code>def wrapworkingctx(ctx):
    class textfulworkingctx(ctx.__class__):
        def filectx(self, path, filelog=None):
            fctx = super(textfulworkingctx, self).filectx(path, filelog)
            return wrapfilectx(fctx)
    ctx.__class__ = textfulworkingctx

def wrapchangectx(ctx):  # 略
</code></pre>

<p>最後に <code>fctx</code> です。 <code>filectx</code> と <code>workingfilectx</code> がありますが、 <code>data()</code>
メソッドの形が同じなので区別する必要はありません。</p>

<pre><code>def wrapfilectx(fctx):
    class textfulfilectx(fctx.__class__):
        def data(self):
            d = super(textfulfilectx, self).data()
            return 'hoge ' + d
    fctx.__class__ = textfulfilectx
</code></pre>

<p>はい、できました。</p>

<h2>そんなんで大丈夫?</h2>

<p>ところで、 Mercurial から見えるファイルの中身を化かしたりして、
リポジトリが壊れたりしないでしょうか?
&mdash; もちろんそんな事はあります。</p>

<p><code>textful</code> エクステンションでは、 <code>fctx.data()</code> を差し替えたままリポジトリへ
ライトアクセスが起きないようにしています。</p>

<pre><code>class textfulrepo(repo.__class__):
    # 略

    def lock(self, wait=True):
        if wait:
            raise error.Abort(_('disallowed to modify textfulrepo'))
        else:
            raise error.LockUnavailable(errno.EACCES,
                                        'Operation denied', '', '')

    def wlock(self, wait=True):
        self.lock(wait)
</code></pre>

<p>リポジトリの書き変え前には、必ずロックをかける決まりになっているので、
ロックを要求されたらアボートさせています。
投機的なロック <code>wait=False</code> には <code>LockUnavalable</code> で答えていますが、
これは、要求がたいていキャッシュ更新前のロックだからです。
呼び出し元はキャッシュ更新をあきらめて、残りの作業を続けることでしょう。</p>

<p>エクステンションのダークサイドが少し見えたような気がしますね。</p>

<p>明日は @y_sumida さんです。よろしくお願いします。</p>

            

            
            <div id="comments">
                <h2>コメント</h2>
                <div id="disqus_thread"></div>
                <script type="text/javascript" src="http://disqus.com/forums/tchaorg/embed.js"></script>
                <noscript>
                    <a href="http://disqus.com/forums/tchaorg/?url=ref">View the discussion thread.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
        </div>

        <script type="text/javascript"><!--
            (function() {
                var links = document.getElementsByTagName('a');
                var query = '?';
                for(var i = 0; i < links.length; i++) {
                    if(links[i].href.indexOf('#disqus_thread') >= 0) {
                        query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
                    }
                }
                document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/tchaorg/get_num_replies.js' + query + '"></' + 'script>');
            })();
        // --></script>
    </body>
</html>
