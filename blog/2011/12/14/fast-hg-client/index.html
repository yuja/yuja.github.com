<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Mercurial をちょっとだけ速くしてみた - Mercurial Advent Calendar 2011 - tcha.org</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="/assets/style.css" media="screen">
        <link rel="alternate" type="application/atom+xml" title="tcha.org Blog" href="/blog.atom">
        <meta name="generator" content="nanoc 3.1.0">
    </head>
    <body>
        <div id="sitenav">
            <a href="/blog/">Blog</a>
            | <a href="/about/">About</a>
        </div>
        <div id="main">
            
            <div id="breadcrumbs"><a href="/">tcha.org</a> » <a href="/blog/">Blog</a> »</div>
            

            
<h1>Mercurial をちょっとだけ速くしてみた - Mercurial Advent Calendar 2011</h1>




<address class="head">
    2011 年 12 月 14 日
    <a href="http://b.hatena.ne.jp/append?http://tcha.org/blog/2011/12/14/fast-hg-client/"><img src="http://b.hatena.ne.jp/images/append.gif" width="16" height="12" alt="はてなブックマークへ追加" title="はてなブックマークへ追加"></a>
<a href="http://b.hatena.ne.jp/entry/http://tcha.org/blog/2011/12/14/fast-hg-client/"><img src="http://b.hatena.ne.jp/entry/image/http://tcha.org/blog/2011/12/14/fast-hg-client/" alt="はてなブックマーク - Mercurial をちょっとだけ速くしてみた - Mercurial Advent Calendar 2011" title="はてなブックマーク - Mercurial をちょっとだけ速くしてみた - Mercurial Advent Calendar 2011"></a>

    <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent('http://tcha.org/blog/2011/12/14/fast-hg-client/')+'&title='+encodeURIComponent('Mercurial をちょっとだけ速くしてみた - Mercurial Advent Calendar 2011'),'delicious', 'toolbar=no,width=550,height=550'); return false;"><img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Bookmark this on Delicious" title="Bookmark this on Delicious"></a>

</address>



            <p>Mercurial ユーザーの皆様こんばんは。
<a href="http://partake.in/events/902cd6d9-0215-4ea3-b51f-b8ff32e56426">Mercurial Advent Calendar 2011</a>
の 14 日目をお送りします。</p>

<p>突然ですが、 <code>hg</code> コマンド、遅くないですか?
Enter キーを押した後の一瞬の間が妙に引っかかりますよね?</p>

<p>Git と比較してみるとオーダーが 1 桁違います。遅いです。(... というか Git 速すぎ。)</p>

<pre><code>% time hg stat
hg stat  0.16s user 0.02s system 96% cpu 0.190 total

% time git status
# On branch master
nothing to commit (working directory clean)
git status  0.02s user 0.01s system 48% cpu 0.067 total
</code></pre>

<p>何か癪なので、少し速い <code>chg</code> コマンドを作ってみました。</p>

<pre><code>% time chg stat
chg stat  0.00s user 0.00s system 0% cpu 0.063 total

... 残念ながら Windows では動きません。ごめんなさい ...
</code></pre>

<p><a href="http://bitbucket.org/yuja/chg/">http://bitbucket.org/yuja/chg/</a></p>

<p><code>chg</code> は <code>C</code> で書いた <code>hg</code> のラッパーです。
仕掛けは単純で、 Mercurial 1.9 で実装された
<a href="http://mercurial.selenic.com/wiki/CommandServer">コマンドサーバー</a>
をバックグラウンドで常駐させ、フロントエンドの <code>chg</code>
はコマンド要求を発行し、その応答を垂れ流しているだけです。
フロントエンドは引数の解釈すらしていません。何という手抜きでしょう。</p>

<p><code>hg</code> コマンド開始後の約 100msec は、ほとんど Python コードのロードに費やされているんですね。</p>

<p>[2011-12-18 追記] Gettext メッセージのロードも? 時間がかかるようです。
<code>LANG=C</code> と <code>LANG=ja_JP.utf-8</code> で 30msec 程度差がありました。</p>

<p>標準のコマンドサーバーにはパイプで通信する機能しかないので、
<code>chg</code> では(適当に実装した)ソケット通信用のエクステンションを使っています。
コマンドサーバーは比較的新しい機能ですが、まだまだいろいろな可能性がありそうですね。</p>

<p><a href="http://partake.in/events/902cd6d9-0215-4ea3-b51f-b8ff32e56426">Advent Calendar</a>
明日は @flyingfoozy さんです。期待してます。</p>

            

            
            <div id="comments">
                <h2>コメント</h2>
                <div id="disqus_thread"></div>
                <script type="text/javascript" src="http://disqus.com/forums/tchaorg/embed.js"></script>
                <noscript>
                    <a href="http://disqus.com/forums/tchaorg/?url=ref">View the discussion thread.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
        </div>

        <script type="text/javascript"><!--
            (function() {
                var links = document.getElementsByTagName('a');
                var query = '?';
                for(var i = 0; i < links.length; i++) {
                    if(links[i].href.indexOf('#disqus_thread') >= 0) {
                        query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
                    }
                }
                document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/tchaorg/get_num_replies.js' + query + '"></' + 'script>');
            })();
        // --></script>
    </body>
</html>
